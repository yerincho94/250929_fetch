<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Poke</title>
    <!-- og tag  -->
    <meta property="og:title" content="포켓몬 관련 이모저모!" />
    <meta
      property="og:description"
      content="포켓몬 최근 검색한 히스토리 기능이 있는 사이트 입니다."
    />
    <meta
      property="og:image"
      content="https://yerincho94.github.io/250929_fetch/preview.png"
    />
    <style>
      /* CSS 추가 (히스토리 항목을 버튼처럼 보이게 하기 위함) */
      .history-area {
        margin-top: 30px;
        padding: 15px;
        border-top: 2px solid #ddd;
      }
      .history-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .history-item-container {
        display: flex; /* 텍스트와 버튼을 한 줄에 배치 */
        align-items: center;
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
      }

      .history-text {
        margin-right: 10px;
        font-weight: bold;
        color: #333;
      }

      .history-search-btn {
        padding: 4px 8px;
        border: none;
        background-color: #3b4cca;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      .history-search-btn:hover {
        background-color: #2a3a9a;
      }
    </style>
  </head>
  <body>
    <section>
      포켓몬 ID / 이름 : <input type="text" min="1" id="pokeId" />
      <button id="pokeBtn">조회</button>
    </section>
    <section id="pokeBox"></section>
    <section id="historyBox" class="history-area"></section>
    <script>
      const POKEMON_API_BASE = "https://pokeapi.co/api/v2/pokemon/";
      const SPECIES_API_BASE = "https://pokeapi.co/api/v2/pokemon-species/";

      const pokeBox = document.querySelector("#pokeBox");

      const HISTORY_KEY = "searchHistory";
      const MAX_HISTORY_COUNT = 5; // 최대 5개까지만 저장

      // --- 1. 히스토리 로직 ---

      // 히스토리 배열을 localStorage에서 가져오는 함수
      function getHistory() {
        const rawHistory = localStorage.getItem(HISTORY_KEY);
        return rawHistory ? JSON.parse(rawHistory) : [];
      }

      // 새로운 검색어를 히스토리에 추가/갱신하는 함수
      function addHistory(newHistoryItem) {
        // newHistoryItem = { query: '1', displayName: '이상해씨' } 형태

        // trim() 처리된 원본 쿼리를 저장
        //const trimmedQuery = String(id).trim().toLowerCase();
        //if (!trimmedQuery) return; // 빈 값은 저장 안함

        let history = getHistory();

        // 1. 중복 제거: 기존에 같은 query(검색어)를 가진 항목이 있으면 제거
        const newHistory = history.filter(
          (item) => item.query !== newHistoryItem.query
        );

        // 2. 맨 앞에 새 항목 추가
        newHistory.unshift(newHistoryItem);

        // 3. 최대 개수 유지
        if (newHistory.length > MAX_HISTORY_COUNT) {
          newHistory.pop();
        }

        // 4. localStorage에 저장 및 UI 업데이트
        localStorage.setItem(HISTORY_KEY, JSON.stringify(newHistory));
        renderHistory(newHistory);
      }

      // 히스토리 목록을 화면에 그리는 함수
      function renderHistory(history) {
        const historyBox = document.querySelector("#historyBox");
        if (!historyBox) return;

        if (history.length === 0) {
          historyBox.innerHTML =
            "<h4>최근 검색</h4><p>최근 검색 기록이 없습니다.</p>";
          return;
        }

        /* const historyListHtml = history
          .map(
            (item) => `
              <button class="history-item" data-query="${item}">
                  ${item}
              </button>
          `
          )
          .join(""); */

        const historyListHtml = history
          .map(
            (item) => `
            <div class="history-item-container">
                <span class="history-text">${item.query} : ${item.displayName}</span>
                <button class="history-search-btn" data-query="${item.query}">
                    재검색
                </button>
            </div>
            `
          )
          .join("");

        historyBox.innerHTML = `
              <h4>최근 검색 (${history.length}/${MAX_HISTORY_COUNT})</h4>
              <div class="history-list">${historyListHtml}</div>
          `;

        // 히스토리 항목 클릭 이벤트 추가
        historyBox.querySelectorAll(".history-search-btn").forEach((button) => {
          button.addEventListener("click", (e) => {
            const query = e.target.dataset.query;
            pokeId.value = query; // 입력 필드에 값 채우기
            getPokemon(query); // 즉시 검색 실행
          });
        });
      }

      //1. API에서 데이터 호출하기
      async function getPokemon(id) {
        const query = String(id).trim().toLowerCase(); // 검색어 정리
        if (!query) {
          pokeBox.innerHTML = `<h4>검색어를 입력해주세요.</h4>`;
          return;
        }

        pokeBox.innerHTML = `<h4>포켓몬 정보를 불러오는 중입니다.</h4>`; //로딩 시작

        try {
          console.log(`${query}번 포켓몬을 불러옵니다.`);

          //첫번째 API 호출 (ID 또는 이름)
          const response = await fetch(`${POKEMON_API_BASE}/${query}`);
          if (!response.ok) {
            // 404 등 응답 오류 처리
            throw new Error("포켓몬 정보를 찾을 수 없습니다.");
          }
          const jsonData = await response.json();
          //모든 데이터 추출
          console.log(jsonData);

          //이름 (영어이름)
          console.log(jsonData.name);

          //한글 이름
          const pokemonId = jsonData.id; // 한글 이름을 위해 ID 추출
          const response2 = await fetch(`${SPECIES_API_BASE}/${pokemonId}`);
          const jsonData2 = await response2.json();
          console.log(jsonData2);

          //console.log(jsonData2.names[2].name);
          console.log(jsonData2.names.filter((v) => v.language.name === "ko"));
          console.log(
            jsonData2.names.filter((v) => v.language.name === "ko")[0].name
          );

          // 한글 이름 추출 로직 (안전성 개선)
          const koNameObj = jsonData2.names.find(
            (v) => v.language.name === "ko"
          );
          // 없으면 영어 이름 사용
          const koName = koNameObj ? koNameObj.name : jsonData.name;

          //3번 함수 호출
          //const koName = jsonData2.names.filter((v) => v.language.name === "ko")[0].name;
          //변수를 바로 넣으면 해당 변수 이름이 key로 인식되어서 바로 들어가게 됨.

          const poke = {
            engName: jsonData.name,
            koName,
            shape_front: jsonData.sprites.front_default,
            shape_back: jsonData.sprites.back_default,
            sound: jsonData.cries.latest,
          };

          localStorage.setItem("recent", JSON.stringify(poke)); //문자열화
          // 히스토리 추가 시: { query: '1', koName: '이상해씨' } 객체 형태로 저장
          addHistory({ query: query, displayName: koName }); // *** 히스토리 추가 ***

          //4번 호출
          renderPoke(poke);
        } catch (error) {
          console.error("API Error: ", error);
          console.log("id: ", id);
          if (id == 0) {
            pokeBox.innerHTML = "<h4>0번 포켓몬은 존재하지 않습니다.</h4>";
          } else {
            pokeBox.innerHTML = `<h4>오류 발생: 포켓몬을 찾을 수 없거나 서버 연결에 문제가 있습니다.</h4>`;
          }
        }
      }
      //getPokemon(1);

      //2. input 통해 번호 바꿔보기 (이벤트 및 초기 로딩)
      const pokeBtn = document.querySelector("#pokeBtn");
      const pokeId = document.querySelector("#pokeId");
      pokeBtn.addEventListener("click", () => getPokemon(pokeId.value));

      //3. 데이터 화면에 그리기
      function renderPoke({ engName, koName, shape_front, shape_back, sound }) {
        pokeBox.innerHTML = `
            <h4>${koName}</h4>
            <h5>${engName}</h5>
            <img src="${shape_front}" />
            <img src="${shape_back}" />
            <audio src="${sound}" controls></audio>
        `;
      }

      //4. 직전 검색 데이터를 storage에 저장되어서 직전 검색 및 히스토리 자동 로딩
      document.addEventListener("DOMContentLoaded", () => {
        const rawRecentPoke = localStorage.getItem("recent"); //문자열
        if (rawRecentPoke) {
          const recentPoke = JSON.parse(rawRecentPoke);
          renderPoke(recentPoke);
        }

        //페이지 로딩 시 히스토리도 로딩
        renderHistory(getHistory());
      });
    </script>
  </body>
</html>
